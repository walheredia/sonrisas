function ChunkedUploader(e) {if(this.id=e.dataset.id,this.element=e,this.files=new Array,this.file_to_upload=0,this.url=e.dataset.url,this.chunk_size=102400,this.slice_method,this.upload_request=new XMLHttpRequest,this.upload_request.onload=this.onChunkComplete,this.upload_request.uploader=this,this.is_paused=!1,this.total_chunks=0,this.server_path=null,this.accept=["image","audio","video"],"undefined"!=typeof e.dataset.accept){this.accept=e.dataset.accept,this.accept=this.accept.split("/*");for(var t=0;t<this.accept.length;t++)""==this.accept[t]?this.accept.splice(t,1):this.accept[t]=this.accept[t].replace("|","")}this.init()}function onConnectionFound(){for(var e=0;e<uploaders.length;e++)uploaders[e+1].onConnectionFound()}function onConnectionLost(){for(var e=0;e<uploaders.length;e++)uploaders[e+1].onConnectionLost()}Element.prototype.remove=function(){this.parentElement.removeChild(this)},Number.prototype.formatBytes=function(){var e,t=["B","KB","MB","GB","TB"],i=this;for(e=0;i>=1024&&4>e;e++)i/=1024;return i.toFixed(2)+t[e]};var uploaders=new Array;ChunkedUploader.prototype={init:function(){var e=this.createElements({element:"form",attributes:{id:"chunked-uploader-form-"+this.id,"class":"chunked-uploader-form",action:this.url,method:"post","data-id":this.id}}),t=this.createElements({element:"div",attributes:{id:"chunked-uploader-images-content-"+this.id,"class":"chunked-uploader-images-content","data-id":this.id}}),i=this.createElements({element:"input",attributes:{id:"chunked-uploader-input-"+this.id,"class":"chunked-uploader-input",type:"file",name:"uploadFiles","data-id":this.id,multiple:!0},event:{trigger:"change",action:this.addFiles}});null!=this.accept&&i.setAttribute("accept",this.accept);var s=this.createElements({element:"a",attributes:{href:"#",id:"chunked-uploader-link-"+this.id,"class":"chunked-uploader-link","data-id":this.id},event:{trigger:"click",action:this.openFilesSelector},content:"Add Files"});if(window.FileReader){var a=this.createElements({element:"p",attributes:{"data-id":this.id},content:"Or drop the files to upload here"});t.addEventListener("dragover",this.cancel),t.addEventListener("dragenter",this.cancel),t.addEventListener("drop",this.filesDroped)}filesP="("+this.accept[0].charAt(0).toUpperCase()+this.accept[0].slice(1);for(var n=1;n<this.accept.length;n++)filesP+=this.accept.length-1>n?", ":" and ",filesP+=this.accept[n];filesP+=" files are accepted)";var d=this.createElements({element:"p",attributes:{"data-id":this.id},content:filesP}),l=this.createElements({element:"div",attributes:{id:"chunk-uploader-list-"+this.id,"class":"chunk-uploader-list","data-id":this.id}}),o=this.createElements({element:"input",attributes:{id:"chunk-uploader-submit-"+this.id,"class":"chunk-uploader-submit",type:"submit",value:"Upload Files","data-id":this.id,disabled:"true"},event:{trigger:"click",action:this.startUpload}});e.appendChild(i),t.appendChild(s),t.appendChild(a),t.appendChild(d),e.appendChild(t),e.appendChild(l),e.appendChild(o),this.element.appendChild(e)},createElements:function(e){var t=document.createElement(e.element);if("undefined"!=typeof e.attributes)for(var i in e.attributes)t.setAttribute(i,e.attributes[i]);return"undefined"!=typeof e.event&&t.addEventListener(e.event.trigger,e.event.action),"undefined"!=typeof e.content&&(t.innerHTML=e.content),t},openFilesSelector:function(e){e.preventDefault();var t=document.getElementById("chunked-uploader-input-"+this.dataset.id);t.click()},addFiles:function(e){var t=e.target.files,i=document.getElementById("chunk-uploader-submit-"+this.dataset.id),s=uploaders[this.dataset.id];s.addFilesToUploader(t),i.disabled=!1},filesDroped:function(e){e.preventDefault();var t=e.target.dataset.id,i=uploaders[t],s=e.dataTransfer.files;i.addFilesToUploader(s)},addFilesToUploader:function(e){for(var t=0;t<e.length;t++){var i=e[t].type.split("/"),s=i[0];this.accept.indexOf(s)>=0?this.files.push(e[t]):(alert('An error was ocurred:\n\n\n - Type file not allowed\n\nWhen try to upload "'+e[t].name+'" file'),e.splice(t,1))}if(this.files.length>0){var a=document.getElementById("chunk-uploader-submit-"+this.id);a.disabled=!1}this.addFilesPreview(e)},addFilesPreview:function(e){for(var t=this.id,i=document.getElementById("chunk-uploader-list-"+t),s=document.getElementById("chunk-uploader-status-"+t),a=0;a<e.length;a++){var n=e[a].type.split("/"),d=n[0],l=n[1],o=this.createElements({element:"div",attributes:{id:"chunk-uploader-preview-"+t+"-"+e[a].name,"class":"chunked-uploader-preview"}}),s=this.createElements({element:"p",attributes:{id:"chunk-uploader-preview-status-"+t+"-"+e[a].name,"class":"chunked-uploader-preview-status"},content:"0%"});o.appendChild(s),i.appendChild(o);var r=new FileReader;r.attachedFile=e[a],r.addEventListener("progress",function(e){var i=document.getElementById("chunk-uploader-preview-status-"+t+"-"+e.target.attachedFile.name);i.innerHTML=Math.round(100*e.loaded/e.total)+"%"}),r.addEventListener("loadend",function(e){var i=document.getElementById("chunk-uploader-preview-status-"+t+"-"+e.target.attachedFile.name),s=document.getElementById("chunk-uploader-preview-"+t+"-"+e.target.attachedFile.name),a=this.result,n=(e.target.attachedFile,uploaders[t]);i.remove(),"video"==d?n.addVideoToList(a,l,s):"audio"==d?n.addAudioToList(a,l,s):n.addImgToList(a,s)}),r.readAsDataURL(e[a])}},addVideoToList:function(e,t,i){var s=this.createElements({element:"video",attributes:{controls:"true"}}),a=this.createElements({element:"source",attributes:{src:e,type:"video/"+t}});s.appendChild(a),i.appendChild(s)},addAudioToList:function(e,t,i){var s=this.createElements({element:"audio",attributes:{controls:"true"}}),a=this.createElements({element:"source",attributes:{src:e,type:"audio/"+t}});s.appendChild(a),i.appendChild(s)},addImgToList:function(e,t){t.setAttribute("style",'background-image: url("'+e+'")')},startUpload:function(e){e.preventDefault();var t=e.target,i=t.dataset.id,s=uploaders[i];t.classList.contains("pause")?(s.pause(),t.classList.remove("pause"),t.classList.add("resume"),t.setAttribute("value","Resume")):t.classList.contains("resume")?(s.resume(),t.classList.add("pause"),t.classList.remove("resume"),t.setAttribute("value","Pause")):(s.file_to_upload=0,s.startUploadFile(),t.classList.add("pause"),t.classList.remove("resume"),t.setAttribute("value","Pause"))},startUploadFile:function(){this.range_start=0,this.range_end=this.chunk_size,this.file_size=this.files[this.file_to_upload].size,this.current_chunk=1,this.total_chunks=Math.ceil(this.files[this.file_to_upload].size/this.chunk_size),this.getSliceMethod(),this.server_path=null;var e=this.createElements({element:"div",attributes:{id:"chunk-uploader-preview-status-background-"+this.id+"-"+this.files[this.file_to_upload].name,"class":"chunk-uploader-preview-status-background"}}),t=this.createElements({element:"p",attributes:{id:"chunk-uploader-preview-status-"+this.id+"-"+this.files[this.file_to_upload].name,"class":"chunked-uploader-preview-status"},content:"0%"});e.appendChild(t),document.getElementById("chunk-uploader-preview-"+this.id+"-"+this.files[this.file_to_upload].name).appendChild(e),this.is_paused||this.upload()},onChunkComplete:function(e){var t=this.uploader,i=JSON.parse(e.target.response);if(i.success){if(t.updateUploadStatus(),t.server_path=i.path,t.range_end===t.file_size)return void t.onUploadComplete(e);t.range_start=t.range_end,t.range_end=t.range_start+t.chunk_size}else{if("critical"==i.type){for(var s=i.status+": \n\n\n",a=0;a<i.error.length;a++)s+=" - "+i.error[a]+"\n\n";return s+='When try to upload "'+t.files[t.file_to_upload].name+'" file',alert(s),void t.onUploadComplete(e)}console.log(i.status)}t.is_paused||t.upload()},onUploadComplete:function(e){beforeUpload(e,this.files[this.file_to_upload]);var t=document.getElementById("chunk-uploader-preview-"+this.id+"-"+this.files[this.file_to_upload].name);if(this.file_to_upload++,this.files.length>this.file_to_upload)this.startUploadFile();else{this.file_to_upload=0,this.files=new Array;var i=document.getElementById("chunk-uploader-submit-"+this.id);i.classList.remove("resume"),i.classList.remove("pause"),i.setAttribute("value","Upload Files"),i.setAttribute("disabled",!0)}window.setTimeout(function(){t.classList.add("hide"),window.setTimeout(function(){t.remove()},400)},300)},upload:function(){var e,t=this,i=this.files[this.file_to_upload];setTimeout(function(){t.range_end>t.file_size&&(t.range_end=t.file_size),e=i[t.slice_method](t.range_start,t.range_end),t.upload_request.open("PUT",t.url+"?file_name="+i.name+"&file_type="+i.type+"&file_size="+e.size+"&path="+t.server_path,!0),t.upload_request.overrideMimeType("application/octet-stream"),0!==t.range_start&&t.upload_request.setRequestHeader("Content-Range","bytes "+t.range_start+"-"+t.range_end+"/"+t.file_size),t.upload_request.send(e)},20)},updateUploadStatus:function(){var e=this.files[this.file_to_upload],t=document.getElementById("chunk-uploader-preview-status-"+this.id+"-"+e.name);t.innerHTML=Math.round(100*this.current_chunk/this.total_chunks)+"%",this.current_chunk++},getSliceMethod:function(){var e=this.files[this.file_to_upload];"mozSlice"in e?this.slice_method="mozSlice":"webkitSlice"in e?this.slice_method="webkitSlice":this.slice_method="slice"},pause:function(){this.is_paused=!0},resume:function(){this.is_paused=!1,this.upload()},cancel:function(e){return e.preventDefault(),!1},onConnectionFound:function(){var e=document.getElementById("chunk-uploader-submit-"+this.id);e.classList.contains("pause")?(this.resume(),e.setAttribute("value","Pause")):e.classList.contains("resume")?e.setAttribute("value","Resume"):e.setAttribute("value","Upload Files"),this.files.length>0&&(e.disabled=!1)},onConnectionLost:function(){this.pause();var e=document.getElementById("chunk-uploader-submit-"+this.id);e.setAttribute("value","Connection Lost"),e.setAttribute("disabled",!0)}},function(){for(var e=document.querySelectorAll("[data-task]"),t=0;t<e.length;t++)e[t].dataset.task&&(uploaders[e[t].dataset.id]=new ChunkedUploader(e[t]));"onLine"in navigator&&(window.addEventListener("online",onConnectionFound),window.addEventListener("offline",onConnectionLost))}();